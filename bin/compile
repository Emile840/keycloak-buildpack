#!/bin/bash
# usage: bin/compile <build-dir> <cache-dir> <env-dir>

set -eo pipefail

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}
buildpack="$(cd -P "$(dirname "$0")" && pwd)"

source "${buildpack}/common.sh"

if [ -n "$BUILDPACK_DEBUG" ]; then
  set -x
fi

KEYCLOAK_PATH="$BUILD_DIR/keycloak"
TOOLS_PATH="$BUILD_DIR/tools"
TMP_PATH="$BUILD_DIR/tmp"
mkdir -p "${BUILD_DIR}/bin" "${CACHE_DIR}/dist" "${TMP_PATH}"
export PATH="$BUILD_DIR/bin:$PATH"

STACK="${STACK:-scalingo-18}"

install_jre

start "Install Keycloak"

if [[ -f "$ENV_DIR/KEYCLOAK_VERSION" ]]; then
  KEYCLOAK_VERSION=$(cat "$ENV_DIR/KEYCLOAK_VERSION")
else
  KEYCLOAK_VERSION="11.0.1"
fi

info "Using keycloak version: ${KEYCLOAK_VERSION}" | indent

start "Fetch keycloak tools"
fetch_keycloak_tools "${KEYCLOAK_VERSION}" "${TOOLS_PATH}" "${TMP_PATH}" | indent
finished

start "Fetch keycloak ${KEYCLOAK_VERSION} dist"
if [ ! -d "${KEYCLOAK_PATH}" ]; then
  fetch_keycloak_dist "${KEYCLOAK_VERSION}" "${TMP_PATH}" | indent
  mv "${TMP_PATH}/keycloak-${KEYCLOAK_VERSION}" "${KEYCLOAK_PATH}"
else
  warn "Keycloak already fetched"
fi
finished

if [[ -f "${ENV_DIR}/FRANCE_CONNECT_VERSION" ]]; then
  FRANCE_CONNECT_VERSION=$(cat "${ENV_DIR}/FRANCE_CONNECT_VERSION")
else
  FRANCE_CONNECT_VERSION="2.1"
fi
start "Add plugin france connect ${FRANCE_CONNECT_VERSION}"
fetch_france_connect_dist "${FRANCE_CONNECT_VERSION}" "${TMP_PATH}" | indent
finished

start "Configure postgresql module"
if [[ -f "${ENV_DIR}/JDBC_POSTGRES_VERSION" ]]; then
  JDBC_POSTGRES_VERSION=$(cat "${ENV_DIR}/JDBC_POSTGRES_VERSION")
else
  JDBC_POSTGRES_VERSION="42.2.16"
fi
info "Using JDBC postgresql version: ${JDBC_POSTGRES_VERSION}" | indent
configure_postgres_module "${JDBC_POSTGRES_VERSION}" "${KEYCLOAK_PATH}" "${TOOLS_PATH}" | indent
finished

start "Configure keycloak"
configure_keycloak "${KEYCLOAK_PATH}" "${TOOLS_PATH}" "${TMP_PATH}" | indent
rm -rf "${KEYCLOAK_PATH}/standalone/tmp/auth"
rm -rf "${KEYCLOAK_PATH}/domain/tmp/auth"
finished

start "Building run"
cp "${TOOLS_PATH}/docker-entrypoint.sh" "${TMP_PATH}/run"
sed -i "/vault.sh/a SYS_PROPS+=-Djboss.http.port=${JBOSS_HTTP_PORT}" "${TMP_PATH}/run"
mv "${TMP_PATH}/run" "${BUILD_DIR}/bin/run"
chmod +x "${BUILD_DIR}/bin/run"
finished

step "Cleaning up tmp files"
rm -rf "${TMP_PATH}"

finished
